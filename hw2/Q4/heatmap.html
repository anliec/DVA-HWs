<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <style>
        body{
            background-color: #222222;
        }

        rect.bordered {
            stroke: #E6E6E6;
            stroke-width: 2px;
        }

        text.mono {
            font-size: 9pt;
            font-family: Consolas, courier;
            fill: #aaa;
        }

        text.axis-borough {
            fill: #000;
        }

        text.axis-crime {
            fill: #000;
        }
    </style>
    <title>Q4</title>
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <!--<script src="http://d3js.org/d3.v4.js"></script>-->
</head>
<body>
<div id="chart"></div>
<div id="dataset-picker">
</div>
<script type="text/javascript">
    const margin = {top: 20, right: 20, bottom: 10, left: 100},
        width = 800 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom,
        gridSize = Math.floor(width / 6),
        buckets = 9,
        legendElementWidth = width / buckets,
        colors = ["#ffffd9", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494", "#081d58"], // alternatively colorbrewer.YlGnBu[9]
        borough = ["Bronx", "Brooklyn", "Manhattan", "Queens", "Staten Island"];

    const svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    yearsDict = {};
    crimeTypeToId = {};
    crimeIdToType = {};
    d3.csv("heatmap.csv")
        .then(function (data) {
            data.forEach(function (d) {
                if (!(d.Year in yearsDict)) {
                    yearsDict[d.Year] = [];
                }
                if(!(d["Crime Type"] in crimeTypeToId)){
                    crimeIdToType[Object.keys(crimeTypeToId).length] = d["Crime Type"];
                    crimeTypeToId[d["Crime Type"]] = Object.keys(crimeTypeToId).length;
                }
                const crime_id = crimeTypeToId[d["Crime Type"]];
                yearsDict[d.Year].push({"borough": 0, "crime_id": crime_id, "crime": +d.Bronx});
                yearsDict[d.Year].push({"borough": 1, "crime_id": crime_id, "crime": +d.Brooklyn});
                yearsDict[d.Year].push({"borough": 2, "crime_id": crime_id, "crime": +d.Manhattan});
                yearsDict[d.Year].push({"borough": 3, "crime_id": crime_id, "crime": +d.Queens});
                yearsDict[d.Year].push({"borough": 4, "crime_id": crime_id, "crime": +d["Staten Island"]});
            });
            const crimes = Object.keys(crimeTypeToId);

            const boroughLabels = svg.selectAll(".boroughLabel")
                .data(borough)
                .enter().append("text")
                .text(function (d) {
                    return d;
                })
                .attr("x", 0)
                .attr("y", (d, i) => i * gridSize)
                .style("text-anchor", "end")
                .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
                .attr("class", (d, i) => ((i >= 0 && i <= 4) ? "boroughLabel mono axis axis-workweek" : "boroughLabel mono axis"));

            const crimeLabels = svg.selectAll(".crimeLabel")
                .data(crimes)
                .enter().append("text")
                .text((d) => d)
                .attr("x", (d, i) => i * gridSize)
                .attr("y", 0)
                .style("text-anchor", "middle")
                .attr("transform", "translate(" + gridSize / 2 + ", -6)")
                .attr("class", (d, i) => ((i >= 7 && i <= 16) ? "crimeLabel mono axis axis-crime" : "timeLabel mono axis"));

            var maxPerYear = [];
            for (let year in yearsDict) {
                maxPerYear.push(d3.max(yearsDict[year], (d) => d.crime));
            }
            var maxCrime = Math.max.apply(Math, maxPerYear);
            console.log(maxPerYear);
            console.log(maxCrime);

            colorScale = d3.scaleQuantile()
                .domain([0, buckets - 1, maxCrime])
                .range(colors);

            update_graph_year(Object.keys(yearsDict)[0]);

            console.log(Object.keys(yearsDict));
            console.log(data);

            var select = d3.select("body")
                .append("div")
                .append("select")
                .on("change", function (d) {
                    var value = d3.select(this).property("value");
                    update_graph_year(value);
                })
                .selectAll("option")
                .data(Object.keys(yearsDict))
                .enter()
                    .append("option")
                    .attr("value", (d) => d)
                    .text((d) => d);

            // const datasetpicker = d3.select("#dataset-picker")
            //     .selectAll(".dataset-button")
            //     .append("select").enter()
            //     .data(Object.keys(yearsDict))
            //     .enter().append("option")
            //     .attr("value", d)
            //     // .on("click", (d) => update_graph_year(d));
    });

    function update_graph_year(year) {
        const data = yearsDict[year];

        const cards = svg.selectAll(".hour")
            .data(data, (d) => d.borough + ':' + d.crime_id);

        cards.append("title");

        cards.enter().append("rect")
            .attr("x", (d) => (d.crime_id) * gridSize)
            .attr("y", (d) => (d.borough) * gridSize)
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("class", "hour bordered")
            .attr("width", gridSize)
            .attr("height", gridSize)
            .style("fill", colors[0])
            .merge(cards)
            .transition()
            .duration(1000)
            .style("fill", (d) => colorScale(d.crime));

        cards.select("title").text((d) => d.crime);

        cards.exit().remove();

        const legend = svg.selectAll(".legend")
            .data([0].concat(colorScale.quantiles()), (d) => d);

        const legend_g = legend.enter().append("g")
            .attr("class", "legend");

        legend_g.append("rect")
            .attr("x", (d, i) => legendElementWidth * i)
            .attr("y", height)
            .attr("width", legendElementWidth)
            .attr("height", gridSize / 2)
            .style("fill", (d, i) => colors[i]);

        legend_g.append("text")
            .attr("class", "mono")
            .text((d) => "â‰¥ " + Math.round(d))
            .attr("x", (d, i) => legendElementWidth * i)
            .attr("y", height + gridSize / 2 + 15);

        legend.exit().remove();
    }

</script>
</body>
</html>
